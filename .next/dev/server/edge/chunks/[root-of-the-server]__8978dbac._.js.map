{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport type { NextRequest } from \"next/server\";\nimport jwt from \"jsonwebtoken\";\n\nconst JWT_SECRET = process.env.JWT_SECRET || \"supersecretkey\";\n\ninterface DecodedToken {\n  id: number;\n  email: string;\n  role: \"admin\" | \"user\";\n}\n\n/**\n * Middleware to protect API routes with JWT authentication.\n *\n * This middleware:\n * 1. Checks for valid access token from cookies or Authorization header\n * 2. Validates token signature and expiry\n * 3. Enforces role-based access control (admin vs user)\n * 4. Attaches user info to request headers for downstream handlers\n *\n * Security Features:\n * - Supports both Bearer token (Authorization header) and cookie-based tokens\n * - Validates token signature to prevent tampering\n * - Checks token expiry to ensure tokens are not reused after expiration\n * - Role-based access control prevents unauthorized access\n * - User info attached via headers (not stored in token)\n *\n * Token Refresh Flow:\n * - If token is expired (401), client should call /api/auth/refresh\n * - Server will issue new access token valid for 15 minutes\n * - This allows seamless re-authentication without user intervention\n */\nexport function middleware(req: NextRequest) {\n  const { pathname } = req.nextUrl;\n\n  // Only protect specific routes\n  if (pathname.startsWith(\"/api/admin\") || pathname.startsWith(\"/api/users\")) {\n    // Extract token from Authorization header or cookies\n    let token: string | undefined;\n\n    // Try Authorization header first (Bearer token)\n    const authHeader = req.headers.get(\"authorization\");\n    if (authHeader && authHeader.startsWith(\"Bearer \")) {\n      token = authHeader.slice(7);\n    }\n\n    // Fall back to access token from cookies\n    if (!token) {\n      token = req.cookies.get(\"accessToken\")?.value;\n    }\n\n    if (!token) {\n      return NextResponse.json(\n        { success: false, message: \"Token missing. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    try {\n      const decoded = jwt.verify(token, JWT_SECRET) as DecodedToken;\n\n      // Role-based access control\n      if (pathname.startsWith(\"/api/admin\") && decoded.role !== \"admin\") {\n        return NextResponse.json(\n          { success: false, message: \"Access denied. Admin role required.\" },\n          { status: 403 }\n        );\n      }\n\n      // Attach user info for downstream handlers\n      const requestHeaders = new Headers(req.headers);\n      requestHeaders.set(\"x-user-id\", decoded.id.toString());\n      requestHeaders.set(\"x-user-email\", decoded.email);\n      requestHeaders.set(\"x-user-role\", decoded.role);\n\n      return NextResponse.next({ request: { headers: requestHeaders } });\n    } catch (error) {\n      // Token verification failed\n      if (error instanceof jwt.TokenExpiredError) {\n        return NextResponse.json(\n          {\n            success: false,\n            message:\n              \"Access token expired. Please use /api/auth/refresh to get a new token.\",\n            code: \"TOKEN_EXPIRED\",\n          },\n          { status: 401 }\n        );\n      }\n\n      return NextResponse.json(\n        { success: false, message: \"Invalid or malformed token\" },\n        { status: 403 }\n      );\n    }\n  }\n\n  return NextResponse.next();\n}\n\n// Configure which routes the middleware applies to\nexport const config = {\n  matcher: [\"/api/admin/:path*\", \"/api/users/:path*\"],\n};\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;;;;;;;AAIA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AA6BtC,SAAS,WAAW,GAAgB;IACzC,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,OAAO;IAEhC,+BAA+B;IAC/B,IAAI,SAAS,UAAU,CAAC,iBAAiB,SAAS,UAAU,CAAC,eAAe;QAC1E,qDAAqD;QACrD,IAAI;QAEJ,gDAAgD;QAChD,MAAM,aAAa,IAAI,OAAO,CAAC,GAAG,CAAC;QACnC,IAAI,cAAc,WAAW,UAAU,CAAC,YAAY;YAClD,QAAQ,WAAW,KAAK,CAAC;QAC3B;QAEA,yCAAyC;QACzC,IAAI,CAAC,OAAO;YACV,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,gBAAgB;QAC1C;QAEA,IAAI,CAAC,OAAO;YACV,OAAO,gMAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAAgC,GAC3D;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI;YACF,MAAM,UAAU,IAAI,MAAM,CAAC,OAAO;YAElC,4BAA4B;YAC5B,IAAI,SAAS,UAAU,CAAC,iBAAiB,QAAQ,IAAI,KAAK,SAAS;gBACjE,OAAO,gMAAY,CAAC,IAAI,CACtB;oBAAE,SAAS;oBAAO,SAAS;gBAAsC,GACjE;oBAAE,QAAQ;gBAAI;YAElB;YAEA,2CAA2C;YAC3C,MAAM,iBAAiB,IAAI,QAAQ,IAAI,OAAO;YAC9C,eAAe,GAAG,CAAC,aAAa,QAAQ,EAAE,CAAC,QAAQ;YACnD,eAAe,GAAG,CAAC,gBAAgB,QAAQ,KAAK;YAChD,eAAe,GAAG,CAAC,eAAe,QAAQ,IAAI;YAE9C,OAAO,gMAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;oBAAE,SAAS;gBAAe;YAAE;QAClE,EAAE,OAAO,OAAO;YACd,4BAA4B;YAC5B,IAAI,iBAAiB,IAAI,iBAAiB,EAAE;gBAC1C,OAAO,gMAAY,CAAC,IAAI,CACtB;oBACE,SAAS;oBACT,SACE;oBACF,MAAM;gBACR,GACA;oBAAE,QAAQ;gBAAI;YAElB;YAEA,OAAO,gMAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,SAAS;YAA6B,GACxD;gBAAE,QAAQ;YAAI;QAElB;IACF;IAEA,OAAO,gMAAY,CAAC,IAAI;AAC1B;AAGO,MAAM,SAAS;IACpB,SAAS;QAAC;QAAqB;KAAoB;AACrD"}}]
}