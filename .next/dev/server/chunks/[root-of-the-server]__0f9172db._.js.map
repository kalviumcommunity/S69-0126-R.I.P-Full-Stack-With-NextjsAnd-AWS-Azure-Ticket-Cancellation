{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/preet_hpydpxe/Downloads/team-1/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\n// Initialize Prisma Client\r\nconst prisma = new PrismaClient();\r\n\r\nexport default prisma;\r\n\r\nexport type User = {\r\n  id: number;\r\n  name: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  role: \"admin\" | \"user\";\r\n  age?: number;\r\n  createdAt: string;\r\n};\r\n\r\nlet nextId = 1;\r\nconst users: User[] = [];\r\n\r\nexport const findUserByEmail = (email: string): User | undefined => {\r\n  return users.find((u) => u.email === email);\r\n};\r\n\r\nexport const createUser = (params: {\r\n  name: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  role?: \"admin\" | \"user\";\r\n  age?: number;\r\n}): User => {\r\n  const user: User = {\r\n    id: nextId++,\r\n    name: params.name,\r\n    email: params.email,\r\n    passwordHash: params.passwordHash,\r\n    role: params.role || \"user\",\r\n    age: params.age,\r\n    createdAt: new Date().toISOString(),\r\n  };\r\n  users.push(user);\r\n  return user;\r\n};\r\n\r\nexport const getAllUsers = (): User[] => {\r\n  return users;\r\n};\r\n\r\nexport type PublicUser = Omit<User, \"passwordHash\">;\r\n\r\nexport const toPublicUser = (user: User): PublicUser => {\r\n  const { passwordHash, ...rest } = user;\r\n  return rest;\r\n};\r\n\r\nexport const getPublicUsers = (): PublicUser[] => users.map(toPublicUser);\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEA,2BAA2B;AAC3B,MAAM,SAAS,IAAI,sMAAY;uCAEhB;AAYf,IAAI,SAAS;AACb,MAAM,QAAgB,EAAE;AAEjB,MAAM,kBAAkB,CAAC;IAC9B,OAAO,MAAM,IAAI,CAAC,CAAC,IAAM,EAAE,KAAK,KAAK;AACvC;AAEO,MAAM,aAAa,CAAC;IAOzB,MAAM,OAAa;QACjB,IAAI;QACJ,MAAM,OAAO,IAAI;QACjB,OAAO,OAAO,KAAK;QACnB,cAAc,OAAO,YAAY;QACjC,MAAM,OAAO,IAAI,IAAI;QACrB,KAAK,OAAO,GAAG;QACf,WAAW,IAAI,OAAO,WAAW;IACnC;IACA,MAAM,IAAI,CAAC;IACX,OAAO;AACT;AAEO,MAAM,cAAc;IACzB,OAAO;AACT;AAIO,MAAM,eAAe,CAAC;IAC3B,MAAM,EAAE,YAAY,EAAE,GAAG,MAAM,GAAG;IAClC,OAAO;AACT;AAEO,MAAM,iBAAiB,IAAoB,MAAM,GAAG,CAAC"}},
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/preet_hpydpxe/Downloads/team-1/src/lib/auth.ts"],"sourcesContent":["import { SignJWT, jwtVerify } from \"jose\";\r\n\r\nexport interface TokenPayload {\r\n  id: number;\r\n  email: string;\r\n  role: \"admin\" | \"user\";\r\n  iat?: number;\r\n  exp?: number;\r\n}\r\n\r\nexport const getJWTSecret = () => {\r\n  return process.env.JWT_SECRET || \"supersecretkey\";\r\n};\r\n\r\n/**\r\n * Sign an access token (24 hours)\r\n */\r\nexport const signAccessToken = async (\r\n  payload: Omit<TokenPayload, \"iat\" | \"exp\">\r\n): Promise<string> => {\r\n  return await new SignJWT(payload as Record<string, unknown>)\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(\"24h\")\r\n    .sign(new TextEncoder().encode(getJWTSecret()));\r\n};\r\n\r\n/**\r\n * Sign a refresh token (long-lived, 7 days)\r\n */\r\nexport const signRefreshToken = async (\r\n  payload: Omit<TokenPayload, \"iat\" | \"exp\">\r\n): Promise<string> => {\r\n  return await new SignJWT(payload as Record<string, unknown>)\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(\"7d\")\r\n    .sign(new TextEncoder().encode(getJWTSecret()));\r\n};\r\n\r\n/**\r\n * Legacy function for backward compatibility - signs 1h token\r\n */\r\nexport const signToken = async (payload: object, expiresIn = \"1h\"): Promise<string> => {\r\n  return await new SignJWT(payload as Record<string, unknown>)\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(expiresIn)\r\n    .sign(new TextEncoder().encode(getJWTSecret()));\r\n};\r\n\r\n/**\r\n * Verify and decode a token using jose (Edge-compatible)\r\n */\r\nexport const verifyToken = async (token: string): Promise<TokenPayload> => {\r\n  try {\r\n    const JWT_SECRET = new TextEncoder().encode(getJWTSecret());\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    return payload as unknown as TokenPayload;\r\n  } catch (error: any) {\r\n    if (error.code === \"ERR_JWT_EXPIRED\") {\r\n      throw new Error(\"Token has expired\");\r\n    }\r\n    throw new Error(\"Invalid token\");\r\n  }\r\n};\r\n\r\n/**\r\n * Verify access token specifically\r\n */\r\nexport const verifyAccessToken = async (token: string): Promise<TokenPayload> => {\r\n  return await verifyToken(token);\r\n};\r\n\r\n/**\r\n * Verify refresh token specifically\r\n */\r\nexport const verifyRefreshToken = async (token: string): Promise<TokenPayload> => {\r\n  return await verifyToken(token);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AAAA;;AAUO,MAAM,eAAe;IAC1B,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI;AACnC;AAKO,MAAM,kBAAkB,OAC7B;IAEA,OAAO,MAAM,IAAI,kKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,OAClB,IAAI,CAAC,IAAI,cAAc,MAAM,CAAC;AACnC;AAKO,MAAM,mBAAmB,OAC9B;IAEA,OAAO,MAAM,IAAI,kKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,MAClB,IAAI,CAAC,IAAI,cAAc,MAAM,CAAC;AACnC;AAKO,MAAM,YAAY,OAAO,SAAiB,YAAY,IAAI;IAC/D,OAAO,MAAM,IAAI,kKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,WAClB,IAAI,CAAC,IAAI,cAAc,MAAM,CAAC;AACnC;AAKO,MAAM,cAAc,OAAO;IAChC,IAAI;QACF,MAAM,aAAa,IAAI,cAAc,MAAM,CAAC;QAC5C,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;QAC3C,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,IAAI,MAAM,IAAI,KAAK,mBAAmB;YACpC,MAAM,IAAI,MAAM;QAClB;QACA,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,MAAM,oBAAoB,OAAO;IACtC,OAAO,MAAM,YAAY;AAC3B;AAKO,MAAM,qBAAqB,OAAO;IACvC,OAAO,MAAM,YAAY;AAC3B"}},
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/preet_hpydpxe/Downloads/team-1/src/app/api/admin/buses/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport prisma from \"@/lib/db\";\r\nimport { verifyToken } from \"@/lib/auth\";\r\n\r\n/**\r\n * PUT /api/admin/buses/[id]\r\n * Edit bus details (busNumber, totalSeats)\r\n */\r\nexport async function PUT(\r\n  request: NextRequest,\r\n  props: { params: Promise<{ id: string }> }\r\n) {\r\n  const params = await props.params;\r\n  try {\r\n    // Check both token types\r\n    let token = request.cookies.get(\"token\")?.value;\r\n    if (!token) {\r\n      token = request.cookies.get(\"accessToken\")?.value;\r\n    }\r\n\r\n    if (!token) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // For simple token, check role cookie\r\n    if (token === \"secure-session\") {\r\n      const role = request.cookies.get(\"role\")?.value;\r\n      if (!role || role !== \"admin\") {\r\n        return NextResponse.json(\r\n          { success: false, error: \"Access denied\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    } else {\r\n      // For JWT tokens, verify\r\n      const payload = await verifyToken(token);\r\n      if (!payload || payload.role !== \"admin\") {\r\n        return NextResponse.json(\r\n          { success: false, error: \"Access denied\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    }\r\n\r\n    const { busNumber, totalSeats } = await request.json();\r\n\r\n    if (!busNumber || !totalSeats) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus number and total seats are required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate bus number: must start with 2 letters, then 1-2 digits, then 1-2 letters, then 3-5 digits\r\n    const busNumberRegex = /^[a-zA-Z]{2}\\d{1,2}[a-zA-Z]{1,2}\\d{3,5}$/;\r\n    if (!busNumberRegex.test(busNumber)) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: \"Bus number format invalid. Example: KL14AB1245 or KL2A1245\",\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const bus = await prisma.bus.update({\r\n      where: { id: parseInt(params.id) },\r\n      data: {\r\n        busNumber,\r\n        totalSeats,\r\n      },\r\n      include: {\r\n        seats: true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: \"Bus updated successfully\",\r\n        data: bus,\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (error: any) {\r\n    console.error(\"Error updating bus:\", error);\r\n\r\n    if (error.code === \"P2025\") {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (error.code === \"P2002\") {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus number already exists\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { success: false, error: \"Failed to update bus\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * DELETE /api/admin/buses/[id]\r\n * Delete a bus and its seats\r\n */\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  props: { params: Promise<{ id: string }> }\r\n) {\r\n  const params = await props.params;\r\n  try {\r\n    // Check both token types\r\n    let token = request.cookies.get(\"token\")?.value;\r\n    if (!token) {\r\n      token = request.cookies.get(\"accessToken\")?.value;\r\n    }\r\n\r\n    if (!token) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // For simple token, check role cookie\r\n    if (token === \"secure-session\") {\r\n      const role = request.cookies.get(\"role\")?.value;\r\n      if (!role || role !== \"admin\") {\r\n        return NextResponse.json(\r\n          { success: false, error: \"Access denied\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    } else {\r\n      // For JWT tokens, verify\r\n      const payload = await verifyToken(token);\r\n      if (!payload || payload.role !== \"admin\") {\r\n        return NextResponse.json(\r\n          { success: false, error: \"Access denied\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    }\r\n\r\n    // Check if bus has booked seats\r\n    const busWithSeats = await prisma.bus.findUnique({\r\n      where: { id: parseInt(params.id) },\r\n      include: {\r\n        seats: {\r\n          where: {\r\n            status: \"BOOKED\",\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!busWithSeats) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    if (busWithSeats.seats.length > 0) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          error: `Cannot delete bus with ${busWithSeats.seats.length} booked seat(s)`,\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Delete bus (cascades to seats)\r\n    await prisma.bus.delete({\r\n      where: { id: parseInt(params.id) },\r\n    });\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: \"Bus deleted successfully\",\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (error: any) {\r\n    console.error(\"Error deleting bus:\", error);\r\n\r\n    if (error.code === \"P2025\") {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus not found\" },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { success: false, error: \"Failed to delete bus\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}