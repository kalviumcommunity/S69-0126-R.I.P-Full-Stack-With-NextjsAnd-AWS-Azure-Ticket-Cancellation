{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/preet_hpydpxe/Downloads/team-1/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\r\n\r\n// Initialize Prisma Client\r\nconst prisma = new PrismaClient();\r\n\r\nexport default prisma;\r\n\r\nexport type User = {\r\n  id: number;\r\n  name: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  role: \"admin\" | \"user\";\r\n  age?: number;\r\n  createdAt: string;\r\n};\r\n\r\nlet nextId = 1;\r\nconst users: User[] = [];\r\n\r\nexport const findUserByEmail = (email: string): User | undefined => {\r\n  return users.find((u) => u.email === email);\r\n};\r\n\r\nexport const createUser = (params: {\r\n  name: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  role?: \"admin\" | \"user\";\r\n  age?: number;\r\n}): User => {\r\n  const user: User = {\r\n    id: nextId++,\r\n    name: params.name,\r\n    email: params.email,\r\n    passwordHash: params.passwordHash,\r\n    role: params.role || \"user\",\r\n    age: params.age,\r\n    createdAt: new Date().toISOString(),\r\n  };\r\n  users.push(user);\r\n  return user;\r\n};\r\n\r\nexport const getAllUsers = (): User[] => {\r\n  return users;\r\n};\r\n\r\nexport type PublicUser = Omit<User, \"passwordHash\">;\r\n\r\nexport const toPublicUser = (user: User): PublicUser => {\r\n  const { passwordHash, ...rest } = user;\r\n  return rest;\r\n};\r\n\r\nexport const getPublicUsers = (): PublicUser[] => users.map(toPublicUser);\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEA,2BAA2B;AAC3B,MAAM,SAAS,IAAI,sMAAY;uCAEhB;AAYf,IAAI,SAAS;AACb,MAAM,QAAgB,EAAE;AAEjB,MAAM,kBAAkB,CAAC;IAC9B,OAAO,MAAM,IAAI,CAAC,CAAC,IAAM,EAAE,KAAK,KAAK;AACvC;AAEO,MAAM,aAAa,CAAC;IAOzB,MAAM,OAAa;QACjB,IAAI;QACJ,MAAM,OAAO,IAAI;QACjB,OAAO,OAAO,KAAK;QACnB,cAAc,OAAO,YAAY;QACjC,MAAM,OAAO,IAAI,IAAI;QACrB,KAAK,OAAO,GAAG;QACf,WAAW,IAAI,OAAO,WAAW;IACnC;IACA,MAAM,IAAI,CAAC;IACX,OAAO;AACT;AAEO,MAAM,cAAc;IACzB,OAAO;AACT;AAIO,MAAM,eAAe,CAAC;IAC3B,MAAM,EAAE,YAAY,EAAE,GAAG,MAAM,GAAG;IAClC,OAAO;AACT;AAEO,MAAM,iBAAiB,IAAoB,MAAM,GAAG,CAAC"}},
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/preet_hpydpxe/Downloads/team-1/src/lib/auth.ts"],"sourcesContent":["import { SignJWT, jwtVerify } from \"jose\";\r\n\r\nexport interface TokenPayload {\r\n  id: number;\r\n  email: string;\r\n  role: \"admin\" | \"user\";\r\n  iat?: number;\r\n  exp?: number;\r\n}\r\n\r\nexport const getJWTSecret = () => {\r\n  return process.env.JWT_SECRET || \"supersecretkey\";\r\n};\r\n\r\n/**\r\n * Sign an access token (24 hours)\r\n */\r\nexport const signAccessToken = async (\r\n  payload: Omit<TokenPayload, \"iat\" | \"exp\">\r\n): Promise<string> => {\r\n  return await new SignJWT(payload as Record<string, unknown>)\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(\"24h\")\r\n    .sign(new TextEncoder().encode(getJWTSecret()));\r\n};\r\n\r\n/**\r\n * Sign a refresh token (long-lived, 90 days)\r\n */\r\nexport const signRefreshToken = async (\r\n  payload: Omit<TokenPayload, \"iat\" | \"exp\">\r\n): Promise<string> => {\r\n  return await new SignJWT(payload as Record<string, unknown>)\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(\"90d\")\r\n    .sign(new TextEncoder().encode(getJWTSecret()));\r\n};\r\n\r\n/**\r\n * Legacy function for backward compatibility - signs 1h token\r\n */\r\nexport const signToken = async (payload: object, expiresIn = \"1h\"): Promise<string> => {\r\n  return await new SignJWT(payload as Record<string, unknown>)\r\n    .setProtectedHeader({ alg: \"HS256\" })\r\n    .setExpirationTime(expiresIn)\r\n    .sign(new TextEncoder().encode(getJWTSecret()));\r\n};\r\n\r\n/**\r\n * Verify and decode a token using jose (Edge-compatible)\r\n */\r\nexport const verifyToken = async (token: string): Promise<TokenPayload> => {\r\n  try {\r\n    const JWT_SECRET = new TextEncoder().encode(getJWTSecret());\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    return payload as unknown as TokenPayload;\r\n  } catch (error: any) {\r\n    if (error.code === \"ERR_JWT_EXPIRED\") {\r\n      throw new Error(\"Token has expired\");\r\n    }\r\n    throw new Error(\"Invalid token\");\r\n  }\r\n};\r\n\r\n/**\r\n * Verify access token specifically\r\n */\r\nexport const verifyAccessToken = async (token: string): Promise<TokenPayload> => {\r\n  return await verifyToken(token);\r\n};\r\n\r\n/**\r\n * Verify refresh token specifically\r\n */\r\nexport const verifyRefreshToken = async (token: string): Promise<TokenPayload> => {\r\n  return await verifyToken(token);\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AAAA;;AAUO,MAAM,eAAe;IAC1B,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI;AACnC;AAKO,MAAM,kBAAkB,OAC7B;IAEA,OAAO,MAAM,IAAI,kKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,OAClB,IAAI,CAAC,IAAI,cAAc,MAAM,CAAC;AACnC;AAKO,MAAM,mBAAmB,OAC9B;IAEA,OAAO,MAAM,IAAI,kKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,OAClB,IAAI,CAAC,IAAI,cAAc,MAAM,CAAC;AACnC;AAKO,MAAM,YAAY,OAAO,SAAiB,YAAY,IAAI;IAC/D,OAAO,MAAM,IAAI,kKAAO,CAAC,SACtB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,iBAAiB,CAAC,WAClB,IAAI,CAAC,IAAI,cAAc,MAAM,CAAC;AACnC;AAKO,MAAM,cAAc,OAAO;IAChC,IAAI;QACF,MAAM,aAAa,IAAI,cAAc,MAAM,CAAC;QAC5C,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;QAC3C,OAAO;IACT,EAAE,OAAO,OAAY;QACnB,IAAI,MAAM,IAAI,KAAK,mBAAmB;YACpC,MAAM,IAAI,MAAM;QAClB;QACA,MAAM,IAAI,MAAM;IAClB;AACF;AAKO,MAAM,oBAAoB,OAAO;IACtC,OAAO,MAAM,YAAY;AAC3B;AAKO,MAAM,qBAAqB,OAAO;IACvC,OAAO,MAAM,YAAY;AAC3B"}},
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/preet_hpydpxe/Downloads/team-1/src/app/api/admin/buses/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport prisma from \"@/lib/db\";\r\nimport { verifyToken, TokenPayload } from \"@/lib/auth\";\r\n\r\n/**\r\n * GET /api/admin/buses\r\n * Fetch all buses\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const buses = await prisma.bus.findMany({\r\n      include: {\r\n        seats: true,\r\n      },\r\n    });\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        data: buses,\r\n      },\r\n      { status: 200 }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"Error fetching buses:\", error);\r\n    return NextResponse.json(\r\n      { success: false, error: \"Failed to fetch buses\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/admin/buses\r\n * Create a new bus with seat layout (2 left, 3 right, ~40 total seats)\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    console.log(\"=== BUS CREATION REQUEST ===\");\r\n\r\n    // Verify admin token from cookies - check both token types\r\n    let token = request.cookies.get(\"token\")?.value;\r\n    if (!token) {\r\n      token = request.cookies.get(\"accessToken\")?.value;\r\n    }\r\n\r\n    console.log(\"Token from cookies:\", token ? \"Present\" : \"Missing\");\r\n\r\n    if (!token) {\r\n      console.log(\"ERROR: No token provided\");\r\n      return NextResponse.json(\r\n        { success: false, error: \"Unauthorized - No token provided\" },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // For simple token from login page, just check role cookie\r\n    if (token === \"secure-session\") {\r\n      const role = request.cookies.get(\"role\")?.value;\r\n\r\n      if (!role || role !== \"admin\") {\r\n        console.log(\"ERROR: User role is not admin:\", role);\r\n        return NextResponse.json(\r\n          { success: false, error: \"Forbidden - Admin access required\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n\r\n      console.log(\"Simple token verified. Role:\", role);\r\n    } else {\r\n      // For JWT tokens, verify with jose\r\n      let decoded: TokenPayload;\r\n      try {\r\n        decoded = await verifyToken(token);\r\n        console.log(\"Token verified. User:\", decoded.email, \"Role:\", decoded.role);\r\n      } catch (error) {\r\n        console.error(\"Token verification failed:\", error);\r\n        return NextResponse.json(\r\n          { success: false, error: \"Invalid token\" },\r\n          { status: 401 }\r\n        );\r\n      }\r\n\r\n      // Check if user is admin\r\n      if (decoded.role !== \"admin\") {\r\n        console.log(\"ERROR: User role is not admin:\", decoded.role);\r\n        return NextResponse.json(\r\n          { success: false, error: \"Forbidden - Admin access required\" },\r\n          { status: 403 }\r\n        );\r\n      }\r\n    }\r\n\r\n    const body = await request.json();\r\n    let {\r\n      busNumber,\r\n      totalSeats = 40,\r\n      leftSeatsPerRow = 2,\r\n      rightSeatsPerRow = 3,\r\n    } = body;\r\n\r\n    console.log(\"Bus creation request:\", { busNumber, totalSeats, leftSeatsPerRow, rightSeatsPerRow });\r\n\r\n    if (!busNumber) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus number is required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Format bus number: convert to uppercase and ensure XX-YY-AA(A)-YYYY format\r\n    // Where XX = exactly 2 letters, YY = 2 numbers, AA = 1-2 letters, YYYY = exactly 4 numbers\r\n    busNumber = busNumber.toUpperCase().replace(/\\s+/g, \"\");\r\n\r\n    // Extract letters and numbers separately\r\n    const letters = busNumber.replace(/[^A-Z]/g, \"\");\r\n    const numbers = busNumber.replace(/[^0-9]/g, \"\");\r\n\r\n    // Must have exactly 2 letters first, then 1-2 more letters (3-4 total) and exactly 6 numbers\r\n    if (letters.length < 3 || letters.length > 4 || numbers.length !== 6) {\r\n      return NextResponse.json(\r\n        { success: false, error: \"Bus number format: 2 letters-2 numbers-1to2 letters-4 numbers (e.g., AB-12-C-3456 or AB-12-CD-3456)\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Format as XX-YY-AA-YYYY or XX-YY-A-YYYY\r\n    // Take first 2 letters, first 2 numbers, remaining letters (1-2), last 4 numbers\r\n    busNumber = `${letters.slice(0, 2)}-${numbers.slice(0, 2)}-${letters.slice(2)}-${numbers.slice(2, 6)}`;\r\n\r\n    // Calculate total rows\r\n    const totalRows = Math.ceil(totalSeats / (leftSeatsPerRow + rightSeatsPerRow));\r\n\r\n    // Create bus\r\n    const bus = await prisma.bus.create({\r\n      data: {\r\n        busNumber,\r\n        totalSeats,\r\n        leftSeatsPerRow,\r\n        rightSeatsPerRow,\r\n        totalRows,\r\n      },\r\n    });\r\n\r\n    console.log(\"Bus created:\", busNumber, \"with ID:\", bus.id);\r\n\r\n    // Create seats for the bus\r\n    const seatsToCreate = [];\r\n    let seatCount = 0;\r\n\r\n    for (let row = 1; row <= totalRows && seatCount < totalSeats; row++) {\r\n      // Left side seats\r\n      for (let seat = 1; seat <= leftSeatsPerRow && seatCount < totalSeats; seat++) {\r\n        seatsToCreate.push({\r\n          busId: bus.id,\r\n          seatNumber: `${row}L`,\r\n          row,\r\n          position: \"LEFT\" as const,\r\n          status: \"AVAILABLE\" as const,\r\n        });\r\n        seatCount++;\r\n      }\r\n\r\n      // Right side seats\r\n      for (let seat = 1; seat <= rightSeatsPerRow && seatCount < totalSeats; seat++) {\r\n        seatsToCreate.push({\r\n          busId: bus.id,\r\n          seatNumber: `${row}R`,\r\n          row,\r\n          position: \"RIGHT\" as const,\r\n          status: \"AVAILABLE\" as const,\r\n        });\r\n        seatCount++;\r\n      }\r\n    }\r\n\r\n    await prisma.seat.createMany({\r\n      data: seatsToCreate,\r\n      skipDuplicates: true,\r\n    });\r\n\r\n    console.log(\"Seats created successfully for bus:\", busNumber);\r\n\r\n    const busWithSeats = await prisma.bus.findUnique({\r\n      where: { id: bus.id },\r\n      include: { seats: true },\r\n    });\r\n\r\n    console.log(\"Bus created successfully:\", busNumber, \"with\", totalSeats, \"seats\");\r\n\r\n    return NextResponse.json(\r\n      {\r\n        success: true,\r\n        message: `Bus created with ${totalSeats} seats`,\r\n        data: busWithSeats,\r\n      },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    console.error(\"ERROR creating bus:\", error);\r\n    return NextResponse.json(\r\n      {\r\n        success: false,\r\n        error: \"Failed to create bus\",\r\n        details: error instanceof Error ? error.message : String(error)\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}